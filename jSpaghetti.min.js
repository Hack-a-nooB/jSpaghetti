!function(){function Route(e,t){this.instruction=e,this.command=t}function State(e,t,n,r){this.route=e,this.shared=t,this.lastProcedureRoute=n,this.isWaitingForSignal=r}function getFirstAttribName(e){return Object.keys(e)[0]}function getInstructionByRoute(e,t){var n=getFirstAttribName(e[t.instruction]),r=e[t.instruction][n];return r}function getCommandByRoute(e,t){var n=getInstructionByRoute(e,t);return n[t.command]}function getNextRoute(e,t){var n=getInstructionByRoute(e,t),r=new Route(t.instruction,t.command);return t.command<n.length-1?r.command+=1:t.instruction<e.length-1?(r.instruction+=1,r.command=0):r=null,r}function getInstructionPosByLabel(e,t){for(var n=0;n<t.length;n++)if(t[n].hasOwnProperty(e))return n;return!1}function checkInstructionsSyntax(e,t){if(e.length>0){for(var n=0;n<e.length;n++){var r=getFirstAttribName(e[n]);"[object Array]"!=Object.prototype.toString.call(e[n][r])&&(e[n][r]=[e[n][r]]);for(var u=0;u<e[n][r].length;u++)switch(typeof e[n][r][u]){case"object":var a=getFirstAttribName(e[n][r][u]);if(-1==INTERNAL_OBJECT_COMMANDS_LIST.indexOf(a))return'Internal command "'+a+'" is undefined';var o=e[n][r][u][a];if(a==GOTOIF_COMMAND){if("[object Array]"!=Object.prototype.toString.call(o))return'Internal command "'+a+'" must receive an array';if(o.length<2)return'Internal command "'+a+'" must receive an array that must have at least 2 positions';for(var s=1;s<o.length;s++){var c=o[s];if(getInstructionPosByLabel(c,e)===!1&&c!=EXIT_COMMAND)return'Instruction label "'+c+'" is undefined'}}break;default:var i=e[n][r][u];if(!t.hasOwnProperty(i)&&i!=EXIT_COMMAND)return'Procedure "'+i+'" is undefined'}}return!0}return"There are no instructions to be executed"}function throwErrorNotification(e,t){console.error("jSpaghetti error:",e,t)}function showDebugMessage(e,t){console.log("jSpaghetti debug:",e,t)}function evaluateExpression(expression,shared){const STORAGETOKEN=/\*/g;expression=String(expression).replace(STORAGETOKEN,"shared");var result=eval(expression);return result}function startSignalListener(e,t){var n=jSpaghetti.modules[e].sequences[t],r=setInterval(function(){(!n.state.route||null!=n.signalChannel&&jSpaghetti.state.ready)&&(clearInterval(r),n.state.route?(jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Roger! ("+e+":"+t+"): ",n.signalChannel),n.state.shared.$=n.signalChannel,n.signalChannel=null,n.state.isWaitingForSignal=!1):jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Signal listener was abruptly interrupted ("+e+":"+t+")"," "),jSpaghetti.modules[e].sequences[t].run(n.state))},DEFAULT_DELAY)}function getSharedFunctions(e,t){return{sendSignal:function(n){(null===n||void 0===n)&&(n="Empty message"),jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Signal sent ("+e+":"+t+"): ",n),jSpaghetti.modules[e].sequences[t].signalChannel=n},getObjectSnapshot:getObjectSnapshot}}function dispatchExitCommand(e,t){jSpaghetti.modules[e].sequences[t].state.route=null,jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Exit command dispatched ("+e+":"+t+")"," ")}function getObjectSnapshot(e){return"object"==typeof e?JSON.parse(JSON.stringify(e)):!1}function getEvent(e){var t=new Event(e);return t}const LAST_COMMAND_TERMINATED="lastCommandTerminated",PAGE_IS_ABOUT_TO_RELOAD="beforeunload",SEQUENCE_TERMINATED="terminated",STORAGE_NAME='"jSpaghetti:" + moduleName + ":" + sequenceName',EXIT_COMMAND="_exit",GOTOIF_COMMAND="gotoif",WAIT_COMMAND="wait",WAIT_FOR_THE_SIGNAL_FLAG="_forTheSignal",WAIT_FOR_PAGE_TO_RELOAD="_forPageToReload",INTERNAL_OBJECT_COMMANDS_LIST=[WAIT_COMMAND,GOTOIF_COMMAND],DEFAULT_DELAY=10;window.addEventListener(PAGE_IS_ABOUT_TO_RELOAD,function(event){jSpaghetti.state.ready=!1;for(var moduleName in jSpaghetti.modules)for(var sequenceName in jSpaghetti.modules[moduleName].sequences){var localStorage=new jSpaghetti.Storage(eval(STORAGE_NAME));localStorage.set(jSpaghetti.modules[moduleName].sequences[sequenceName].state)}});var jSpaghetti={state:{ready:!0},version:"0.1",modules:{},module:function(moduleName){var currentModule=jSpaghetti.modules[moduleName],module={config:{debugMode:!1},sequences:{},procedures:{},procedure:function(e,t){currentModule.procedures[e]=t},sequence:function(sequenceName){var currentSequence=currentModule.sequences[sequenceName],initialRoute=new Route(0,0),initialState=new State(initialRoute,{$:void 0},null,!1),sequence={events:document.createDocumentFragment(),state:initialState,signalChannel:null,instructions:[],run:function(lastState){setTimeout(function(){if(jSpaghetti.state.ready){if(lastState)currentSequence.state=lastState,currentModule.config.debugMode&&showDebugMessage("Data recovered from the last state ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(currentSequence.state));else{var localStorage=new jSpaghetti.Storage(eval(STORAGE_NAME)),storedData=localStorage.get();storedData?(currentSequence.state=storedData,currentModule.config.debugMode&&showDebugMessage("Data recovered from the local storage ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(currentSequence.state))):currentModule.config.debugMode&&showDebugMessage("Data recovered from the initial state ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(currentSequence.state))}var resultSyntaxCheck=checkInstructionsSyntax(currentSequence.instructions,currentModule.procedures);if(currentSequence.state.route&&resultSyntaxCheck===!0){var listener=document.createDocumentFragment();listener.addEventListener(LAST_COMMAND_TERMINATED,function(){currentModule.sequences[sequenceName].run(currentSequence.state)}),currentSequence.state.isWaitingForSignal&&(currentSequence.state.isWaitingForSignal=!1,currentSequence.state.route=currentSequence.state.lastProcedureRoute);var currentCommand=getCommandByRoute(currentSequence.instructions,currentSequence.state.route),nextRoute=getNextRoute(currentSequence.instructions,currentSequence.state.route);switch(typeof currentCommand){case"object":switch(Object.keys(currentCommand)[0]){case WAIT_COMMAND:if(currentCommand[WAIT_COMMAND]==WAIT_FOR_THE_SIGNAL_FLAG)currentSequence.state.isWaitingForSignal=!0,currentSequence.state.route=nextRoute,startSignalListener(moduleName,sequenceName),currentModule.config.debugMode&&showDebugMessage("Waiting for the signal ("+moduleName+":"+sequenceName+")"," ");else if(currentCommand[WAIT_COMMAND]==WAIT_FOR_PAGE_TO_RELOAD)currentSequence.state.route=nextRoute,currentModule.config.debugMode&&showDebugMessage("Waiting for page to reload ("+moduleName+":"+sequenceName+")"," ");else{var timeToWait=evaluateExpression(currentCommand[WAIT_COMMAND],currentSequence.state.shared);currentModule.config.debugMode&&showDebugMessage("Waiting "+timeToWait+" ms ("+moduleName+":"+sequenceName+")"," ");var waitCount=0,loop=setInterval(function(){waitCount++,(!currentSequence.state.route||waitCount>=timeToWait/DEFAULT_DELAY)&&(clearInterval(loop),currentSequence.state.route?currentSequence.state.route=nextRoute:currentModule.config.debugMode&&showDebugMessage("Wait process was abruptly interrupted ("+moduleName+":"+sequenceName+")"," "),listener.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED)))},DEFAULT_DELAY)}break;case GOTOIF_COMMAND:if(evaluateExpression(currentCommand[GOTOIF_COMMAND][0],currentSequence.state.shared))if(currentModule.config.debugMode&&showDebugMessage("Gotoif returned true ("+moduleName+":"+sequenceName+")"," "),currentCommand[GOTOIF_COMMAND][1]!=EXIT_COMMAND){var redirect=currentCommand[GOTOIF_COMMAND][1];currentSequence.state.route.command=0,currentSequence.state.route.instruction=getInstructionPosByLabel(currentCommand[GOTOIF_COMMAND][1],currentSequence.instructions)}else dispatchExitCommand(moduleName,sequenceName);else if(currentModule.config.debugMode&&showDebugMessage("Gotoif returned false ("+moduleName+":"+sequenceName+")"," "),currentCommand[GOTOIF_COMMAND].length>2)if(currentCommand[GOTOIF_COMMAND][2]!=EXIT_COMMAND){var redirect=currentCommand[GOTOIF_COMMAND][2];currentSequence.state.route.command=0,currentSequence.state.route.instruction=getInstructionPosByLabel(currentCommand[GOTOIF_COMMAND][2],currentSequence.instructions)}else dispatchExitCommand(moduleName,sequenceName);else currentSequence.state.route=nextRoute;redirect&&currentModule.config.debugMode&&showDebugMessage('Flow redirected to "'+redirect+'" ('+moduleName+":"+sequenceName+")"," "),listener.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED))}break;default:currentCommand!=EXIT_COMMAND?(currentSequence.state.lastProcedureRoute=new Route(currentSequence.state.route.instruction,currentSequence.state.route.command),currentSequence.state.route=nextRoute,currentModule.config.debugMode&&showDebugMessage("Running procedure",'"'+moduleName+":"+sequenceName+":"+currentCommand+'"'),setTimeout(function(){currentSequence.state.shared.$=currentModule.procedures[currentCommand](currentSequence.state.shared,getSharedFunctions(moduleName,sequenceName)),listener.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED))},0)):(dispatchExitCommand(moduleName,sequenceName),listener.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED)))}}else resultSyntaxCheck!==!0&&throwErrorNotification(resultSyntaxCheck+" ("+moduleName+":"+sequenceName+")"," "),null==currentSequence.state.route&&(currentModule.config.debugMode&&showDebugMessage("Sequence is terminated ("+moduleName+":"+sequenceName+")"," "),currentSequence.events.dispatchEvent(getEvent(SEQUENCE_TERMINATED)))}else currentModule.config.debugMode&&showDebugMessage("jSpaghetti is not ready: Probably the page is about to be reloaded ("+moduleName+":"+sequenceName+")"," ")},DEFAULT_DELAY)},reset:function(){currentSequence.state.route=null,setTimeout(function(){var routeReseted=new Route(0,0);currentSequence.state=new State(routeReseted,{$:void 0},null,!1);var localStorage=new jSpaghetti.Storage(eval(STORAGE_NAME));localStorage.get()&&localStorage.reset(),currentModule.config.debugMode&&showDebugMessage("Sequence is reset ("+moduleName+":"+sequenceName+")"," ")},20)}};return void 0==currentSequence&&(currentModule.sequences[sequenceName]=sequence,currentSequence=currentModule.sequences[sequenceName]),currentModule.sequences[sequenceName]}};return void 0==currentModule&&(jSpaghetti.modules[moduleName]=module,currentModule=jSpaghetti.modules[moduleName]),currentModule},Storage:function(e){this.storageName=e,this.get=function(){return JSON.parse(sessionStorage.getItem(this.storageName))},this.set=function(e){sessionStorage.setItem(this.storageName,JSON.stringify(e))},this.reset=function(){sessionStorage.removeItem(this.storageName)}}};return $jSpaghetti=jSpaghetti}();
